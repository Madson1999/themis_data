<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/protocolo.css" />
  <title>Themis Data - Protocola√ß√£o</title>

</head>

<body>
  <header class="header">
    <div class="logo-header" onclick="window.location.href='/menu'" style="cursor:pointer;">
      <img src="images/logo.png" alt="Themis Data Logo">
      <h1>Themis Data</h1>
    </div>
    <div class="user-info">
      <div class="user-avatar">
        <img id="userAvatar" alt="Avatar do usu√°rio"
          onerror="this.style.display='none'; document.querySelector('.fallback').style.display='flex';">
        <div class="fallback" id="userAvatarFallback">?</div>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-start;">
        <span id="userNome"></span>
        <span id="userNivelAcesso" style="font-size:.95em; color:#667eea; font-weight:500;"></span>
      </div>
      <button class="menu-toggle" onclick="toggleMenu()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </button>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="/usuarios">üë• Editar Usu√°rios</a>
        <a href="#" onclick="alterarSenha()">üîí Alterar Senha</a>
        <a href="#" onclick="configuracoes()">‚öôÔ∏è Configura√ß√µes</a>
        <a href="#" onclick="ajuda()">‚ùì Ajuda</a>
        <a href="/" class="logout-option">üö™ Sair</a>
      </div>
    </div>
  </header>

  <div class="tabela">
    <!-- Filtro por data -->
    <div class="filtros">
      <div class="filtro-grupo">
        <label for="filtroData">Data Filtro</label>
        <input type="date" id="filtroData">
      </div>

      <button class="btn btn-filtrar" id="btnFiltrar">üîç Filtrar</button>
      <button class="btn btn-limpar" id="btnLimpar">‚Ü∫ Limpar</button>

      <div class="filtro-grupo">
        <label for="filtroProt">Protocolado</label>
        <select id="filtroProt">
          <option value="nao">N√£o protocolados</option>
          <option value="sim">Protocolados</option>
          <option value="todos">Todos</option>
        </select>
      </div>
    </div>

    <table border="1">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>T√≠tulo</th>
          <th>Designado</th>
          <th>Protocolado</th>
          <th>Data Aprovado</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabela-protocolacao">
        <tr>
          <td colspan="7">Carregando...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal de Documentos -->
  <div id="modalDocumentos" class="modal-docs">
    <div class="modal-docs-bg" onclick="fecharModalDocumentos()"></div>
    <div class="modal-docs-content">
      <button class="modal-docs-close" onclick="fecharModalDocumentos()">√ó</button>
      <h3 id="modalDocsTitulo">Documentos da A√ß√£o</h3>
      <div id="modalDocsLista" class="modal-docs-lista"></div>
    </div>
  </div>

  <script src="js/script.js"></script>

  <script>
    // ----- helpers -----
    function formatarSomenteData(valor) {
      if (!valor) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
        const [y, m, d] = valor.split("-");
        return `${d}/${m}/${y}`;
      }
      const dt = new Date(valor);
      return isNaN(dt.getTime()) ? String(valor) : dt.toLocaleDateString('pt-BR');
    }

    const filtro = { dataAprovado: '', protocolado: 'nao' };

    // ----- render tabela -----
    async function carregarProtocolacao() {
      const tbody = document.getElementById('tabela-protocolacao');
      tbody.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';

      try {
        const res = await fetch('/api/protocolacao');
        let dados = await res.json();


        // precisa ter data_aprovado (SEM filtrar protocolado aqui!)
        dados = dados.filter(item => item.data_aprovado);

        // filtro por data (YYYY-MM-DD)
        if (filtro.dataAprovado) {
          dados = dados.filter(item => {
            const iso = /^\d{4}-\d{2}-\d{2}$/.test(item.data_aprovado)
              ? item.data_aprovado
              : new Date(item.data_aprovado).toISOString().split('T')[0];
            return iso === filtro.dataAprovado;
          });
        }

        // filtro de protocolado (novo select)
        if (filtro.protocolado !== 'todos') {
          const mostrarSoProtocolados = (filtro.protocolado === 'sim');
          dados = dados.filter(item => mostrarSoProtocolados ? item.protocolado : !item.protocolado);
        }

        tbody.innerHTML = '';

        if (dados.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">Nenhum registro encontrado</td></tr>';
          return;
        }

        dados.forEach(item => {
          const tr = document.createElement('tr');
          const isProt = item.protocolado;

          tr.innerHTML = `
        <td data-label="ID">${item.id}</td>
        <td data-label="Cliente">${item.cliente ?? ''}</td>
        <td data-label="T√≠tulo">${item.titulo ?? ''}</td>
        <td data-label="Designado">${item.designado ?? ''}</td>
        <td data-label="Protocolado">
          ${isProt ? '<span class="badge badge-ok">‚úÖ Protocolado</span>' : '<span class="badge badge-no">‚ùå N√£o Protocolado</span>'}
        </td>
        <td data-label="Data Aprovado">${/^\d{4}-\d{2}-\d{2}$/.test(item.data_aprovado)
              ? item.data_aprovado.split('-').reverse().join('/')
              : new Date(item.data_aprovado).toLocaleDateString('pt-BR')
            }</td>
        <td data-label="A√ß√µes">
            <button class="btn btn-baixar" title="Ver e baixar arquivos"
              onclick="verArquivos(${item.id}, '${(item.titulo || '').replace(/'/g, "\\'")}')">üìÇ Arquivos</button>
              
            ${isProt ? '' : `<button class="btn btn-protocolar" onclick="marcarProtocolado(${item.id})" title="Marcar como protocolado">‚úÖ Protocolar</button>`}

            <button class="btn btn-devolver" onclick="devolverAcao(${item.id})" title="Devolver a√ß√£o">‚Ü©Ô∏è Devolver</button>
        </td>
      `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error('Erro ao carregar dados:', err);
        tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar dados</td></tr>';
      }
    }


    async function marcarProtocolado(id) {
      const ok = confirm("Confirma que j√° protocolou este processo no Projudi (ou outro sistema)?");
      if (!ok) return;
      try {
        const res = await fetch(`/api/protocolacao/${id}/protocolar`, { method: 'PUT' });
        if (res.ok) {
          alert("‚úÖ Protocolado com sucesso!");
          carregarProtocolacao();
        } else {
          const txt = await res.text().catch(() => '');
          alert("‚ö†Ô∏è Erro ao atualizar. " + (txt || "Tente novamente."));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erro de conex√£o com o servidor.");
      }
    }

    async function devolverAcao(id) {
      const ok = confirm("‚ö†Ô∏è Deseja realmente devolver esta a√ß√£o? Ela sair√° da lista de aprovadas.");
      if (!ok) return;

      try {
        // chamada ao backend para limpar 'data_aprovado'
        const res = await fetch(`/api/protocolacao/${id}/devolver`, { method: 'DELETE' });
        if (res.ok) {
          alert("‚Ü©Ô∏è A√ß√£o devolvida com sucesso!");
          carregarProtocolacao(); // recarrega a tabela
        } else {
          const txt = await res.text().catch(() => '');
          alert("‚ö†Ô∏è Erro ao devolver. " + (txt || "Tente novamente."));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erro de conex√£o com o servidor.");
      }
    }


    // ----- Modal -----
    function abrirModalDocumentos(titulo) {
      document.getElementById('modalDocsTitulo').textContent = titulo || 'Documentos da A√ß√£o';
      document.getElementById('modalDocumentos').classList.add('show');
    }
    function fecharModalDocumentos() {
      document.getElementById('modalDocumentos').classList.remove('show');
      document.getElementById('modalDocsLista').innerHTML = '';
    }

    async function verArquivos(acaoId, titulo) {
      const lista = document.getElementById('modalDocsLista');
      lista.innerHTML = '<div class="modal-docs-empty">Carregando arquivos...</div>';
      abrirModalDocumentos(`Documentos da A√ß√£o #${acaoId} ‚Äî ${titulo}`);

      try {
        const res = await fetch(`/api/protocolacao/${acaoId}/arquivos`);
        const arquivos = await res.json();

        if (!arquivos || !arquivos.length) {
          lista.innerHTML = '<div class="modal-docs-empty">Nenhum arquivo encontrado nesta a√ß√£o.</div>';
          return;
        }

        const wrap = document.createElement('div');
        wrap.className = 'modal-docs-arquivos';

        arquivos.forEach(a => {
          const card = document.createElement('div');
          card.className = 'modal-docs-arquivo-card';
          card.innerHTML = `
            <span class="modal-docs-arquivo-icon">üìÑ</span>
            <span class="modal-docs-arquivo-nome" title="${a.nome}">${a.nome}</span>
            <a class="modal-docs-arquivo-link" href="${a.url}" target="_blank" rel="noopener" title="Baixar">‚¨áÔ∏è Baixar</a>
          `;
          wrap.appendChild(card);
        });

        lista.innerHTML = '';
        lista.appendChild(wrap);
      } catch (e) {
        console.error(e);
        lista.innerHTML = '<div class="modal-docs-empty">Erro ao carregar os arquivos.</div>';
      }
    }

    // ----- Filtros -----
    document.getElementById('btnFiltrar').addEventListener('click', () => {
      filtro.dataAprovado = document.getElementById('filtroData').value || '';
      filtro.protocolado = document.getElementById('filtroProt').value;
      carregarProtocolacao();
    });

    document.getElementById('btnLimpar').addEventListener('click', () => {
      document.getElementById('filtroData').value = '';
      document.getElementById('filtroProt').value = 'nao';
      filtro.dataAprovado = '';
      filtro.protocolado = 'nao';
      carregarProtocolacao();
    });

    document.getElementById('filtroProt').addEventListener('change', e => {
      filtro.protocolado = e.target.value;
      carregarProtocolacao();
    });

    // ----- Inicializa -----
    document.addEventListener('DOMContentLoaded', () => {
      carregarProtocolacao();
    });
  </script>
</body>

</html>