<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/styles.css">
  <title>Themis Data - Usu√°rios</title>

  <style>
    .main-content {
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }

    .table-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(102, 126, 234, 0.08);
    }

    th,
    td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 700;
      color: #4f46e5;
      letter-spacing: 0.3px;
    }

    tr:nth-child(even) {
      background: #f4f6fb;
    }

    tr:hover {
      background: #e0e7ff;
      transition: background 0.2s;
    }

    .btn {
      padding: 0.7rem 1.3rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(90deg, #5a6fd8 0%, #6c3eb4 100%);
      color: #fff;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.18);
    }

    .btn-danger {
      background: linear-gradient(90deg, #dc3545 0%, #b91c1c 100%);
      color: white;
    }

    .btn-danger:hover {
      background: linear-gradient(90deg, #c82333 0%, #991b1b 100%);
      color: #fff;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 16px rgba(220, 53, 69, 0.18);
    }

    .btn-sm {
      padding: 0.4rem 1rem;
      font-size: 0.9rem;
      border-radius: 6px;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-buttons .btn {
      border-radius: 50px;
      min-width: 36px;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }

      .main-content {
        padding: 1rem;
      }

      .table-container {
        padding: 1rem;
      }

      table,
      th,
      td {
        font-size: 0.95rem;
      }
    }

    /* Modal aprimorado */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.35);
      animation: fadeInBg 0.3s;
    }

    @keyframes fadeInBg {
      from {
        background: rgba(0, 0, 0, 0);
      }

      to {
        background: rgba(0, 0, 0, 0.35);
      }
    }

    .modal-content {
      background: linear-gradient(135deg, #f8fafc 0%, #e9eafc 100%);
      margin: 5% auto;
      padding: 2rem;
      border-radius: 14px;
      max-width: 420px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.18), 0 2px 8px rgba(0, 0, 0, 0.10);
      border: 1.5px solid #e0e7ff;
      animation: modalPop 0.35s cubic-bezier(.23, 1.01, .32, 1);
    }

    @keyframes modalPop {
      from {
        transform: translateY(-40px) scale(0.95);
        opacity: 0;
      }

      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .modal-content h3 {
      font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
      font-size: 1.4rem;
      color: #4f46e5;
      margin-bottom: 1.2rem;
    }

    .modal-content .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }

    .modal-content .close:hover {
      color: #4f46e5;
    }

    /* Inputs e selects do modal aprimorados */
    #modalUsuario .form-group {
      display: flex;
      flex-direction: column;
      width: 100%;
      margin-bottom: 1.1rem;
    }

    #modalUsuario .form-group input,
    #modalUsuario .form-group select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.85rem;
      border: 1.5px solid #d1d5db;
      border-radius: 10px;
      font-size: 1.05rem;
      background: #f6f8fc;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.10);
      transition: border-color 0.3s, box-shadow 0.3s, background 0.3s;
      margin-top: 0.2rem;
    }

    #modalUsuario .form-group input:focus,
    #modalUsuario .form-group select:focus {
      outline: none;
      border-color: #667eea;
      background: #eef2ff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.18), 0 2px 8px rgba(102, 126, 234, 0.10);
    }

    #modalUsuario .form-group label {
      margin-bottom: 0.4rem;
      font-weight: 600;
      color: #4f46e5;
      font-size: 1.01rem;
      letter-spacing: 0.2px;
    }
  </style>
</head>

<body>

  <header class="header">
    <div class="logo-header" onclick="window.location.href='/menu'" style="cursor:pointer;">
      <img src="/images/logo.png" alt="Themis Data Logo">
      <h1>Themis Data</h1>
    </div>
    <div class="user-info">
      <div class="user-avatar">
        <img id="userAvatar" alt="Avatar do usu√°rio"
          onerror="this.style.display='none'; document.querySelector('.fallback').style.display='flex';">
        <div class="fallback" id="userAvatarFallback">?</div>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-start;">
        <span id="userNome"></span>
        <span id="userNivelAcesso" style="font-size:0.95em; color:#667eea; font-weight:500;"></span>
      </div>
      <button class="menu-toggle" onclick="toggleMenu()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </button>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="#" onclick="alterarSenha()">üîí Alterar Senha</a>
        <a href="#" onclick="configuracoes()">‚öôÔ∏è Configura√ß√µes</a>
        <a href="#" onclick="ajuda()">‚ùì Ajuda</a>
        <a href="/" class="logout-option">üö™ Sair</a>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="stat-card">
      <div class="stat-number" id="usuariosTotal">0</div>
      <div class="stat-label">Usu√°rios Cadastrados</div>
    </div>
    <div class="table-container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #4f46e5;">Usu√°rios do Sistema</h2>
        <button class="btn btn-primary" onclick="abrirModalUsuario()">+ Novo Usu√°rio</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Email</th>
            <th>N√≠vel de Acesso</th>
            <th>Data de Cria√ß√£o</th>
            <th>√öltimo Acesso</th>
            <th>Ativo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="usuariosTableBody">
          <!-- Dados ser√£o carregados dinamicamente -->
        </tbody>
      </table>
    </div>
  </main>
  <!-- Modal de usu√°rio (adicionar/editar) -->
  <div id="modalUsuario" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px;">
      <span class="close" onclick="fecharModalUsuario()"
        style="position:absolute; top:10px; right:20px; font-size:28px; cursor:pointer;">&times;</span>
      <h3 id="modalUsuarioTitulo">Novo Usu√°rio</h3>
      <form id="formUsuario">
        <input type="hidden" id="usuario_id" name="id">
        <div class="form-group"><label for="usuario_nome">Nome</label><input type="text" id="usuario_nome" name="nome"
            required></div>
        <div class="form-group"><label for="usuario_email">Email</label><input type="email" id="usuario_email"
            name="email" required></div>
        <div class="form-group"><label for="usuario_senha">Senha</label><input type="password" id="usuario_senha"
            name="senha" required></div>
        <div class="form-group"><label for="usuario_nivel">N√≠vel de Acesso</label>
          <select id="usuario_nivel" name="nivel_acesso" required>
            <option value="admin">Admin</option>
            <option value="adv">Advogado(a)</option>
            <option value="gerente">Gerente</option>
            <option value="estagiario">Estagi√°rio(a)</option>
            <option value="secretaria">Secret√°ria</option>
          </select>
        </div>
        <div class="form-group"><label for="usuario_ativo">Ativo</label>
          <select id="usuario_ativo" name="ativo" required>
            <option value="1">Sim</option>
            <option value="0">N√£o</option>
          </select>
        </div>
        <div style="margin-top:1.5rem; display:flex; gap:1rem; justify-content:flex-end;">
          <button type="button" class="btn btn-secondary" onclick="fecharModalUsuario()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>


  <script src="/js/script.js"></script>


  <script>
    // Fun√ß√µes para abrir/fechar modal
    function abrirModalUsuario(usuario = null) {
      document.getElementById('formUsuario').reset();
      document.getElementById('modalUsuarioTitulo').textContent = usuario ? 'Editar Usu√°rio' : 'Novo Usu√°rio';
      if (usuario) {
        document.getElementById('usuario_id').value = usuario.id;
        document.getElementById('usuario_nome').value = usuario.nome;
        document.getElementById('usuario_email').value = usuario.email;
        document.getElementById('usuario_nivel').value = usuario.nivel_acesso;
        document.getElementById('usuario_ativo').value = usuario.ativo;
        document.getElementById('usuario_senha').required = false;
      } else {
        document.getElementById('usuario_id').value = '';
        document.getElementById('usuario_senha').required = true;
      }
      document.getElementById('modalUsuario').style.display = 'block';
    }
    function fecharModalUsuario() {
      document.getElementById('modalUsuario').style.display = 'none';
    }
    // Fun√ß√£o para carregar e exibir os usu√°rios na tabela
    async function carregarUsuarios() {
      try {
        const resposta = await fetch('/api/usuarios');
        const usuarios = await resposta.json();

        // Atualiza o total de usu√°rios
        document.getElementById('usuariosTotal').textContent = usuarios.length;

        // Monta as linhas da tabela
        const tbody = document.getElementById('usuariosTableBody');
        tbody.innerHTML = '';
        usuarios.forEach(usuario => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${usuario.id}</td>
            <td>${usuario.nome}</td>
            <td>${usuario.email}</td>
            <td>${usuario.nivel_acesso}</td>
            <td>${usuario.data_criacao ? new Date(usuario.data_criacao).toLocaleString('pt-BR') : ''}</td>
            <td>${usuario.ultimo_acesso ? new Date(usuario.ultimo_acesso).toLocaleString('pt-BR') : ''}</td>
            <td>${usuario.ativo == 1 ? 'Sim' : 'N√£o'}</td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-primary" onclick='abrirModalUsuario(${JSON.stringify(usuario)})'>‚úèÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        alert('Erro ao carregar usu√°rios!');
        console.error(error);
      }
    }

    // Ap√≥s carregar o nome do usu√°rio, buscar e exibir o n√≠vel de acesso
    async function carregarUsuarioLogado() {
      try {
        const resposta = await fetch('/api/usuario-logado');
        if (!resposta.ok) return;
        const usuario = await resposta.json();
        document.getElementById('userNome').textContent = usuario.nome;
        let nivel = usuario.nivel_acesso;
        // Traduzir para portugu√™s se necess√°rio
        switch (nivel) {
          case 'admin': nivel = 'Administrador'; break;
          case 'adv': nivel = 'Advogado'; break;
          case 'gerente': nivel = 'Gerente'; break;
          case 'estagiario': nivel = 'Estagi√°rio'; break;
          case 'secretaria': nivel = 'Secret√°ria'; break;
        }
        document.getElementById('userNivelAcesso').textContent = nivel;
      } catch (e) { }
    }
    carregarUsuarioLogado();

    // Carregar usu√°rios ao abrir a p√°gina
    window.onload = carregarUsuarios;

    // Intercepta o submit do formul√°rio de usu√°rio
    document.getElementById('formUsuario').addEventListener('submit', async function (event) {
      event.preventDefault();

      const id = document.getElementById('usuario_id').value;
      const nome = document.getElementById('usuario_nome').value;
      const email = document.getElementById('usuario_email').value;
      const senha = document.getElementById('usuario_senha').value;
      const nivel_acesso = document.getElementById('usuario_nivel').value;
      const ativo = document.getElementById('usuario_ativo').value;

      let usuario = {};
      let url = '/api/usuarios';
      let method = 'POST';

      if (id) {
        // Edi√ß√£o: s√≥ envia campos preenchidos
        if (nome) usuario.nome = nome;
        if (email) usuario.email = email;
        if (senha) usuario.senha = senha;
        if (nivel_acesso) usuario.nivel_acesso = nivel_acesso;
        if (ativo) usuario.ativo = ativo;
        url += '/' + id;
        method = 'PUT';
      } else {
        // Cadastro: todos obrigat√≥rios
        usuario = { nome, email, senha, nivel_acesso, ativo };
      }

      try {
        const resposta = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(usuario)
        });
        const resultado = await resposta.json();
        if (resposta.ok && resultado.sucesso) {
          alert(id ? 'Usu√°rio atualizado com sucesso!' : 'Usu√°rio cadastrado com sucesso!');
          fecharModalUsuario();
          carregarUsuarios();
        } else {
          alert(resultado.mensagem || 'Erro ao salvar usu√°rio!');
        }
      } catch (error) {
        alert('Erro ao salvar usu√°rio!');
        console.error(error);
      }
    });
  </script>
</body>

</html>